<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>THEOS Tracker - Cesium 3D</title>
  <script src="satellite.min.js"></script>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    .toolbar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 6px;
      z-index: 999;
    }
    .toolbar label, .toolbar input {
      display: block;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div class="toolbar">
    <label>เลือกวันที่:</label>
    <input type="date" id="datePicker" />
    <label><input type="checkbox" id="theos1" checked /> แสดง THEOS</label>
    <label><input type="checkbox" id="theos2" checked /> แสดง THEOS-2</label>
    <label>เลือกเวลาเริ่มต้น:</label>
    <input type="time" id="startTime" value="00:00" />
    <label>เลือกเวลาสิ้นสุด:</label>
    <input type="time" id="endTime" value="23:59" />
  </div>

  <script>
    const viewer = new Cesium.Viewer("cesiumContainer", {
      imageryProvider: new Cesium.IonImageryProvider({ assetId: 3845 }),
      baseLayerPicker: false,
      timeline: false,
      animation: false,
      shouldAnimate: true
    });

    const tleData = {
      "THEOS": [
        "1 33396U 08049A   25083.87213906  .00000283  00000+0  15311-3 0  9995",
        "2 33396  98.6176 149.1908 0001332  96.9286 263.2042 14.20082670854190"
      ],
      "THEOS-2": [
        "1 58016U 23155A   25083.88629186  .00003640  00000+0  46978-3 0  9991",
        "2 58016  97.9047 156.2251 0001223  90.4571 269.6781 14.81595690 78893"
      ]
    };

    function getTimeInMinutes(t) {
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }

    function propagateOrbit(tle, date, startMin, endMin) {
      const satrec = satellite.twoline2satrec(tle[0], tle[1]);
      const positions = [];
      for (let i = startMin; i <= endMin; i += 2) {
        const time = new Date(date.getTime() + i * 60000);
        const posVel = satellite.propagate(satrec, time);
        if (!posVel.position) continue;
        const gmst = satellite.gstime(time);
        const geo = satellite.eciToGeodetic(posVel.position, gmst);
        const lat = Cesium.Math.toDegrees(geo.latitude);
        const lon = Cesium.Math.toDegrees(geo.longitude);
        const height = geo.height * 1000;
        positions.push(Cesium.Cartesian3.fromDegrees(lon, lat, height));
      }
      return positions;
    }

    function plotSatellites() {
      viewer.entities.removeAll();

      const date = new Date(document.getElementById("datePicker").value);
      const startMin = getTimeInMinutes(document.getElementById("startTime").value);
      const endMin = getTimeInMinutes(document.getElementById("endTime").value);
      const showTheos = document.getElementById("theos1").checked;
      const showTheos2 = document.getElementById("theos2").checked;

      if (showTheos) {
        const pos1 = propagateOrbit(tleData["THEOS"], date, startMin, endMin);
        if (pos1.length) {
          viewer.entities.add({ polyline: { positions: pos1, width: 2, material: Cesium.Color.YELLOW } });
          viewer.entities.add({ position: pos1[0], point: { pixelSize: 10, color: Cesium.Color.YELLOW }, label: { text: "THEOS", font: "14px sans-serif", fillColor: Cesium.Color.YELLOW } });
        }
      }

      if (showTheos2) {
        const pos2 = propagateOrbit(tleData["THEOS-2"], date, startMin, endMin);
        if (pos2.length) {
          viewer.entities.add({ polyline: { positions: pos2, width: 2, material: Cesium.Color.RED } });
          viewer.entities.add({ position: pos2[0], point: { pixelSize: 10, color: Cesium.Color.RED }, label: { text: "THEOS-2", font: "14px sans-serif", fillColor: Cesium.Color.RED } });
        }
      }
    }

    document.getElementById("datePicker").valueAsDate = new Date();
    document.querySelectorAll("#datePicker, #startTime, #endTime, #theos1, #theos2").forEach(el => el.addEventListener("change", plotSatellites));
    plotSatellites();
  </script>
</body>
</html>
